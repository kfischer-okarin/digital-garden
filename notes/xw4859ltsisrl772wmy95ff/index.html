<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/digital-garden/favicon.ico"/><title>In-Memory r2d2 Pool</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="Kevin Fischer&#x27;s Digital Garden."/><meta property="og:title" content="In-Memory r2d2 Pool"/><meta property="og:description" content="Kevin Fischer&#x27;s Digital Garden."/><meta property="og:url" content="https://kfischer-okarin.github.io/digital-garden/notes/xw4859ltsisrl772wmy95ff/"/><meta property="og:type" content="article"/><meta property="article:published_time" content="3/22/2023"/><meta property="article:modified_time" content="3/22/2023"/><link rel="canonical" href="https://kfischer-okarin.github.io/digital-garden/notes/xw4859ltsisrl772wmy95ff/"/><link rel="alternate" type="application/atom+xml" href="https://kfischer-okarin.github.io/digital-garden/feed.xml"/><meta name="next-head-count" content="15"/><link rel="preload" href="/digital-garden/_next/static/css/caa87292aeb9e4dd.css" as="style"/><link rel="stylesheet" href="/digital-garden/_next/static/css/caa87292aeb9e4dd.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/digital-garden/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/digital-garden/_next/static/chunks/webpack-9b44dd033dc5a33d.js" defer=""></script><script src="/digital-garden/_next/static/chunks/framework-28c999baf2863c3d.js" defer=""></script><script src="/digital-garden/_next/static/chunks/main-84ee3c869fba1bf0.js" defer=""></script><script src="/digital-garden/_next/static/chunks/pages/_app-3bf77397468264ea.js" defer=""></script><script src="/digital-garden/_next/static/chunks/935-4dee79e80b8641c6.js" defer=""></script><script src="/digital-garden/_next/static/chunks/6-50972def09142ee2.js" defer=""></script><script src="/digital-garden/_next/static/chunks/pages/notes/%5Bid%5D-78d472fa3b924116.js" defer=""></script><script src="/digital-garden/_next/static/ZHTExSfdYZOrTr6Qnkw5j/_buildManifest.js" defer=""></script><script src="/digital-garden/_next/static/ZHTExSfdYZOrTr6Qnkw5j/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><section class="ant-layout" style="width:100%;min-height:100%"><header class="ant-layout-header" style="position:fixed;isolation:isolate;z-index:1;width:100%;border-bottom:1px solid #d4dadf;height:64px;padding:0 24px 0 2px"><div class="ant-row ant-row-center" style="max-width:992px;justify-content:space-between;margin:0 auto"><div style="display:flex" class="ant-col ant-col-xs-20 ant-col-sm-4"></div><div class="ant-col gutter-row ant-col-xs-0 ant-col-sm-20 ant-col-md-20 ant-col-lg-19"><div class="ant-select ant-select-lg ant-select-auto-complete ant-select-single ant-select-allow-clear ant-select-show-search" style="width:100%"><div class="ant-select-selector"><span class="ant-select-selection-search"><input type="search" autoComplete="off" class="ant-select-selection-search-input" role="combobox" aria-haspopup="listbox" aria-owns="undefined_list" aria-autocomplete="list" aria-controls="undefined_list" aria-activedescendant="undefined_list_0" value=""/></span><span class="ant-select-selection-placeholder">For full text search please use the &#x27;?&#x27; prefix. e.g. ? Onboarding</span></div></div></div><div style="display:none;align-items:center;justify-content:center" class="ant-col ant-col-xs-4 ant-col-sm-4 ant-col-md-0 ant-col-lg-0"><span role="img" aria-label="menu" style="font-size:24px" tabindex="-1" class="anticon anticon-menu"><svg viewBox="64 64 896 896" focusable="false" data-icon="menu" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></span></div></div></header><section class="ant-layout" style="margin-top:64px;display:flex;flex-direction:row"><div class="site-layout-sidebar" style="flex:0 0 auto;width:calc(max((100% - 992px) / 2, 0px) + 200px);min-width:200px;padding-left:calc((100% - 992px) / 2)"><aside class="ant-layout-sider ant-layout-sider-dark" style="position:fixed;overflow:auto;height:calc(100vh - 64px);background-color:transparent;flex:0 0 200px;max-width:200px;min-width:200px;width:200px"><div class="ant-layout-sider-children"></div></aside></div><main class="ant-layout-content side-layout-main" style="max-width:1200px;min-width:0;display:block"><div style="padding:0 24px"><div class="main-content" role="main"><div class="ant-row"><div class="ant-col ant-col-24"><div class="ant-row" style="margin-left:-10px;margin-right:-10px"><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-24 ant-col-md-18"><div><h1 id="in-memory-r2d2-pool">In-Memory r2d2 Pool<a aria-hidden="true" class="anchor-heading icon-link" href="#in-memory-r2d2-pool"></a></h1>
<p>Made in collaboration with Bing</p>
<pre class="language-rs"><code class="language-rs">use r2d2::{ManageConnection, Pool};
use std::collections::HashMap;
use std::sync::{Arc, Mutex};

// - `Mutex` type provides thread-safe access to the data.
//   Since r2d2 allows multiple threads to use the same connection pool, and each connection may be used by different
//   threads at different times, it is important to ensure that concurrent access to the data does not cause data races
//   or corruption. The Mutex type provides a lock-based synchronization mechanism that ensures only one thread can
//   access the data at a time.
// - The `Arc` provides shared ownership of the data.
//   Since r2d2 allows connections to be cloned and returned to the pool when they are dropped, it is important to
//   ensure that the data is not dropped prematurely when one of the clones goes out of scope. The Arc type provides a
//   reference-counted pointer that keeps track of how many owners there are for the data and only drops it when there
//   are no more owners left.
type Data = Arc&#x3C;Mutex&#x3C;HashMap&#x3C;String, String>>>;

// A struct that implements ManageConnection for Data
struct DataManager {
    data: Data,
}

impl DataManager {
    fn new() -> Self {
        DataManager {
            data: Arc::new(Mutex::new(HashMap::new())),
        }
    }
}

#[derive(Debug)]
enum ConnectionError {
    LockError,
}

impl std::fmt::Display for ConnectionError {
    fn fmt(&#x26;self, f: &#x26;mut std::fmt::Formatter) -> std::fmt::Result {
        match self {
            ConnectionError::LockError => write!(f, "LockError"),
        }
    }
}

impl std::error::Error for ConnectionError {}

impl ManageConnection for DataManager {
    type Connection = Data;
    type Error = ConnectionError;

    fn connect(&#x26;self) -> Result&#x3C;Self::Connection, Self::Error> {
        Ok(self.data.clone())
    }

    // Check if the connection is valid by trying to lock it
    fn is_valid(&#x26;self, conn: &#x26;mut Self::Connection) -> Result&#x3C;(), Self::Error> {
        match conn.lock() {
            Ok(_) => Ok(()),
            Err(_e) => Err(ConnectionError::LockError),
        }
    }

    // Do nothing when the connection is recycled
    fn has_broken(&#x26;self, _conn: &#x26;mut Self::Connection) -> bool {
        false
    }
}

// A function that creates a connection pool
fn create_pool() -> Pool&#x3C;DataManager> {
    // Create a pool using the custom manager
    Pool::builder()
        .max_size(10)
        .build(DataManager::new())
        .unwrap()
}
</code></pre>
<ul>
<li><code>Mutex</code> type provides thread-safe access to the data
Since r2d2 allows multiple threads to use the same connection pool, and each connection may be used by different
threads at different times, it is important to ensure that concurrent access to the data does not cause data races or
corruption. The Mutex type provides a lock-based synchronization mechanism that ensures only one thread can access the
data at a time.</li>
<li>The <code>Arc&#x3C;Mutex&#x3C;HashMap&#x3C;String, String>>></code> type wraps the Mutex in an Arc to provide shared ownership of the data. Since r2d2 allows connections to be cloned and returned to the pool when they are dropped, it is important to ensure that the data is not dropped prematurely when one of the clones goes out of scope. The Arc type provides a reference-counted pointer that keeps track of how many owners there are for the data and only drops it when there are no more owners left.</li>
</ul>
<p>These choices allow us to implement a simple and safe in-memory connection manager for r2d2 that can handle concurrent and dynamic usage patterns.</p></div></div><div style="padding-left:10px;padding-right:10px" class="ant-col ant-col-xs-0 ant-col-md-6"><div><div class=""><div class="ant-anchor-wrapper dendron-toc" style="max-height:calc(100vh - 64px);z-index:1"><div class="ant-anchor"><div class="ant-anchor-ink"><span class="ant-anchor-ink-ball"></span></div><div class="ant-anchor-link"><a class="ant-anchor-link-title" href="#in-memory-r2d2-pool" title="In-Memory r2d2 Pool">In-Memory r2d2 Pool</a></div></div></div></div></div></div></div></div></div></div></div><div class="ant-divider ant-divider-horizontal" role="separator"></div><footer class="ant-layout-footer" style="padding:0 24px 24px"></footer></main></section></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"id":"xw4859ltsisrl772wmy95ff","title":"In-Memory r2d2 Pool","desc":"","updated":1679504496375,"created":1679503982859,"custom":{},"fname":"reference.dev.rust.code-snippets.in-memory-r2d2-pool","type":"note","vault":{"fsPath":".","name":"digital-garden","selfContained":true},"contentHash":"349d1f8bebf0450ebba4af018bff33d1","links":[],"anchors":{"in-memory-r2d2-pool":{"type":"header","text":"In-Memory r2d2 Pool","value":"in-memory-r2d2-pool","line":7,"column":0,"depth":1}},"children":[],"parent":"qb4whqj9igej5l9on0r2jhe","data":{}},"body":"\u003ch1 id=\"in-memory-r2d2-pool\"\u003eIn-Memory r2d2 Pool\u003ca aria-hidden=\"true\" class=\"anchor-heading icon-link\" href=\"#in-memory-r2d2-pool\"\u003e\u003c/a\u003e\u003c/h1\u003e\n\u003cp\u003eMade in collaboration with Bing\u003c/p\u003e\n\u003cpre class=\"language-rs\"\u003e\u003ccode class=\"language-rs\"\u003euse r2d2::{ManageConnection, Pool};\nuse std::collections::HashMap;\nuse std::sync::{Arc, Mutex};\n\n// - `Mutex` type provides thread-safe access to the data.\n//   Since r2d2 allows multiple threads to use the same connection pool, and each connection may be used by different\n//   threads at different times, it is important to ensure that concurrent access to the data does not cause data races\n//   or corruption. The Mutex type provides a lock-based synchronization mechanism that ensures only one thread can\n//   access the data at a time.\n// - The `Arc` provides shared ownership of the data.\n//   Since r2d2 allows connections to be cloned and returned to the pool when they are dropped, it is important to\n//   ensure that the data is not dropped prematurely when one of the clones goes out of scope. The Arc type provides a\n//   reference-counted pointer that keeps track of how many owners there are for the data and only drops it when there\n//   are no more owners left.\ntype Data = Arc\u0026#x3C;Mutex\u0026#x3C;HashMap\u0026#x3C;String, String\u003e\u003e\u003e;\n\n// A struct that implements ManageConnection for Data\nstruct DataManager {\n    data: Data,\n}\n\nimpl DataManager {\n    fn new() -\u003e Self {\n        DataManager {\n            data: Arc::new(Mutex::new(HashMap::new())),\n        }\n    }\n}\n\n#[derive(Debug)]\nenum ConnectionError {\n    LockError,\n}\n\nimpl std::fmt::Display for ConnectionError {\n    fn fmt(\u0026#x26;self, f: \u0026#x26;mut std::fmt::Formatter) -\u003e std::fmt::Result {\n        match self {\n            ConnectionError::LockError =\u003e write!(f, \"LockError\"),\n        }\n    }\n}\n\nimpl std::error::Error for ConnectionError {}\n\nimpl ManageConnection for DataManager {\n    type Connection = Data;\n    type Error = ConnectionError;\n\n    fn connect(\u0026#x26;self) -\u003e Result\u0026#x3C;Self::Connection, Self::Error\u003e {\n        Ok(self.data.clone())\n    }\n\n    // Check if the connection is valid by trying to lock it\n    fn is_valid(\u0026#x26;self, conn: \u0026#x26;mut Self::Connection) -\u003e Result\u0026#x3C;(), Self::Error\u003e {\n        match conn.lock() {\n            Ok(_) =\u003e Ok(()),\n            Err(_e) =\u003e Err(ConnectionError::LockError),\n        }\n    }\n\n    // Do nothing when the connection is recycled\n    fn has_broken(\u0026#x26;self, _conn: \u0026#x26;mut Self::Connection) -\u003e bool {\n        false\n    }\n}\n\n// A function that creates a connection pool\nfn create_pool() -\u003e Pool\u0026#x3C;DataManager\u003e {\n    // Create a pool using the custom manager\n    Pool::builder()\n        .max_size(10)\n        .build(DataManager::new())\n        .unwrap()\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eMutex\u003c/code\u003e type provides thread-safe access to the data\nSince r2d2 allows multiple threads to use the same connection pool, and each connection may be used by different\nthreads at different times, it is important to ensure that concurrent access to the data does not cause data races or\ncorruption. The Mutex type provides a lock-based synchronization mechanism that ensures only one thread can access the\ndata at a time.\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003eArc\u0026#x3C;Mutex\u0026#x3C;HashMap\u0026#x3C;String, String\u003e\u003e\u003e\u003c/code\u003e type wraps the Mutex in an Arc to provide shared ownership of the data. Since r2d2 allows connections to be cloned and returned to the pool when they are dropped, it is important to ensure that the data is not dropped prematurely when one of the clones goes out of scope. The Arc type provides a reference-counted pointer that keeps track of how many owners there are for the data and only drops it when there are no more owners left.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThese choices allow us to implement a simple and safe in-memory connection manager for r2d2 that can handle concurrent and dynamic usage patterns.\u003c/p\u003e","noteIndex":{"id":"w4mxpqpj9ftyo6pw17k3wj6","title":"Home","desc":"","updated":1660372010574,"created":1648806032875,"custom":{"nav_order":0,"permalink":"/"},"fname":"root","type":"note","vault":{"fsPath":".","name":"digital-garden","selfContained":true},"contentHash":"0d5b5a84c07edaf83aeeab9a0b1a2b42","links":[{"type":"wiki","from":{"fname":"root","id":"w4mxpqpj9ftyo6pw17k3wj6","vaultName":"digital-garden"},"value":"contact_me","position":{"start":{"line":10,"column":55,"offset":331},"end":{"line":10,"column":69,"offset":345},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"contact_me"}},{"type":"wiki","from":{"fname":"root","id":"w4mxpqpj9ftyo6pw17k3wj6","vaultName":"digital-garden"},"value":"areas.gamedev","position":{"start":{"line":14,"column":3,"offset":402},"end":{"line":14,"column":20,"offset":419},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"areas.gamedev"}},{"type":"wiki","from":{"fname":"root","id":"w4mxpqpj9ftyo6pw17k3wj6","vaultName":"digital-garden"},"value":"areas.software-development","position":{"start":{"line":15,"column":3,"offset":422},"end":{"line":15,"column":33,"offset":452},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"areas.software-development"}},{"type":"wiki","from":{"fname":"root","id":"w4mxpqpj9ftyo6pw17k3wj6","vaultName":"digital-garden"},"value":"reference.faith-and-work","position":{"start":{"line":17,"column":5,"offset":517},"end":{"line":17,"column":33,"offset":545},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"reference.faith-and-work"}},{"type":"wiki","from":{"fname":"root","id":"w4mxpqpj9ftyo6pw17k3wj6","vaultName":"digital-garden"},"value":"reference.adhd","position":{"start":{"line":19,"column":3,"offset":583},"end":{"line":19,"column":21,"offset":601},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"reference.adhd"}},{"type":"wiki","from":{"fname":"root","id":"w4mxpqpj9ftyo6pw17k3wj6","vaultName":"digital-garden"},"value":"areas.pkm","alias":"Personal Knowledge Management (PKM)","position":{"start":{"line":20,"column":3,"offset":604},"end":{"line":20,"column":52,"offset":653},"indent":[]},"xvault":false,"sameFile":false,"to":{"fname":"areas.pkm"}}],"anchors":{"welcome-to-my-little-corner-of-the-internet":{"type":"header","text":"Welcome to my little corner of the internet","value":"welcome-to-my-little-corner-of-the-internet","line":7,"column":0,"depth":1},"topics-i-care-about":{"type":"header","text":"Topics I care about","value":"topics-i-care-about","line":19,"column":0,"depth":2},"media-i-enjoy":{"type":"header","text":"Media I enjoy","value":"media-i-enjoy","line":28,"column":0,"depth":2}},"children":["ckpt5dqzm4fv2ysnyyqi5q7","qexkgwym6yebjwrl1pz2wco","contact_me","gk4xjszil72ursnl10ui5ht","tu102fn6psvc3ef33p2jl5p","426vv89cwpwrk3pezm4idax","ceagbmx4k3i5sokhd3n8iyf","43bj5hyl41q0txr2e0rhcaw","sjq1fqcpyomz6hii19blfsh","krioclkr3atix89tw0300y8","5j5jqiz50loi24n5r18y9kd","hn6qnp0te5vs8l76eik6o4c"],"parent":null,"data":{},"body":"# Welcome to my little corner of the internet\n\nHey, everyone!\n\nI'm Kevin and this page is my own shot at a Digital Garden[^1].\n\nThis is a low-barrier[^2] experiment for myself to organize my thoughts and publish content and maybe find like-minded\nindividuals to connect with.\n\nThis space will slowly evolve over time. Feel free to [[contact_me]] if you want to get in touch.\n\n\n## Topics I care about\n- [[areas.gamedev]]\n- [[areas.software-development]]\n- Christian Faith and how it relates to several other areas\n  - [[reference.faith-and-work]]\n  - Faith and Creativity/Art/Media\n- [[reference.adhd]]\n- [[Personal Knowledge Management (PKM)|areas.pkm]]\n\n## Media I enjoy\n- ðŸ‡¯ðŸ‡µ Anime/Manga\n  - Steins;Gate\n  - Attack on Titan\n  - Death Note\n- ðŸ“º TV Series\n  - Twelve Monkeys\n  - Dark\n  - Deep Space 9\n- ðŸŽ¥ Movies\n  - Big Fish\n  - Memento\n- ðŸ“– Books\n  - Das Haus der Geschichten (Thomas Franke)\n  - The Screwtape Letters (C.S. Lewis)\n- ðŸŽ® Video Games\n  - Secret of Mana (SNES)\n  - Outer Wilds\n  - Undertale\n\n\n[^1]: I recommend the explanation on [Joschua's Garden](https://joschuasgarden.com/Digital+garden) and his digital garden in general.\n\n[^2]: I personally thought several times about starting a blog for sharing game development, software engineering tidbits/ramblings but my tendency for perfectionism especially with regard to minor details like names, design, style as well as the perceived pressure of having to regularly output some kind of meaningful content stopped me from actually going through with it until now.\n"},"collectionChildren":null,"customHeadContent":"\u003clink rel=\"alternate\" type=\"application/atom+xml\" href=\"https://kfischer-okarin.github.io/digital-garden/feed.xml\"\u003e\n","config":{"version":5,"dev":{"enablePreviewV2":true},"commands":{"lookup":{"note":{"selectionMode":"extract","confirmVaultOnCreate":true,"vaultSelectionModeOnCreate":"smart","leaveTrace":true,"bubbleUpCreateNew":true,"fuzzThreshold":0.2}},"randomNote":{},"insertNote":{"initialValue":"templates"},"insertNoteLink":{"aliasMode":"none","enableMultiSelect":false},"insertNoteIndex":{"enableMarker":false},"copyNoteLink":{"aliasMode":"title"},"templateHierarchy":"template"},"workspace":{"enableFullHierarchyNoteTitle":false,"vaults":[{"fsPath":".","name":"digital-garden","selfContained":true}],"journal":{"dailyDomain":"daily","name":"journal","dateFormat":"y.MM.dd","addBehavior":"childOfDomain"},"scratch":{"name":"scratch","dateFormat":"y.MM.dd.HHmmss","addBehavior":"asOwnDomain"},"task":{"name":"","dateFormat":"","addBehavior":"childOfCurrent","statusSymbols":{"":" ","wip":"w","done":"x","assigned":"a","moved":"m","blocked":"b","delegated":"l","dropped":"d","pending":"y"},"prioritySymbols":{"H":"high","M":"medium","L":"low"},"todoIntegration":false,"createTaskSelectionType":"selection2link","taskCompleteStatus":["done","x"]},"graph":{"zoomSpeed":1,"createStub":false},"enableAutoCreateOnDefinition":false,"enableXVaultWikiLink":false,"enableRemoteVaultInit":true,"enableUserTags":false,"enableHashTags":true,"workspaceVaultSyncMode":"noCommit","enableAutoFoldFrontmatter":false,"enableEditorDecorations":true,"maxPreviewsCached":10,"maxNoteLength":204800},"preview":{"enableFMTitle":false,"enableNoteTitleForLink":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"automaticallyShowPreview":false},"publishing":{"siteUrl":"https://kfischer-okarin.github.io","assetsPrefix":"/digital-garden","customHeaderPath":"header.html","enableFMTitle":false,"enableNoteTitleForLink":true,"enableMermaid":true,"enablePrettyRefs":true,"enableKatex":true,"copyAssets":true,"siteHierarchies":["root"],"writeStubs":false,"siteRootDir":"docs","seo":{"title":"My Digital Garden","description":"Kevin Fischer's Digital Garden.","author":"Kevin Fischer"},"github":{"enableEditLink":false,"editLinkText":"Edit this page on GitHub","editBranch":"main","editViewMode":"tree"},"enableSiteLastModified":true,"enableFrontmatterTags":true,"enableHashesForFMTags":false,"enableRandomlyColoredTags":true,"enablePrettyLinks":true,"enableTaskNotes":true,"searchMode":"lookup","siteFaviconPath":"favicon.ico","siteIndex":"root"}}},"__N_SSG":true},"page":"/notes/[id]","query":{"id":"xw4859ltsisrl772wmy95ff"},"buildId":"ZHTExSfdYZOrTr6Qnkw5j","assetPrefix":"/digital-garden","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>